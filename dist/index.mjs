var B=Object.defineProperty;var O=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var j=(e,o,t)=>o in e?B(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t,x=(e,o)=>{for(var t in o||(o={}))_.call(o,t)&&j(e,t,o[t]);if(O)for(var t of O(o))F.call(o,t)&&j(e,t,o[t]);return e};import*as m from"vite";import H from"node:os";function z(e){return Object.prototype.toString.call(e)==="[object RegExp]"}function N(e){return Object.prototype.toString.call(e)==="[object String]"}function f(e){return Object.prototype.toString.call(e)==="[object Object]"}function k(e){return Array.isArray(e)}function E(e){return Object.prototype.toString.call(e)==="[object Function]"}function C(e){return Object.prototype.toString.call(e)==="[object Boolean]"}function M(e,o){for(let t of o)if(z(t)){if(t.test(e))return!0}else if(N(t)&&e.includes(t))return!0;return!1}import{Worker as W}from"node:worker_threads";import V from"node:path";import $ from"javascript-obfuscator";var d=class{constructor(o){this.show=o;this._log=o?console.log.bind(console):this.noop}noop(o){}forceLog(...o){console.log(...o)}info(o){this._log(o)}};function L(e){let o=Math.floor(e/36e5),t=Math.floor(e%36e5/6e4),s=Math.floor(e%6e4/1e3);return[o?`${o}h `:"",t?`${t}m `:"",s||!o&&!t?`${s}s`:""].filter(Boolean).join("")}function S(e){let{threadPool:o}=e;return C(o)?o:f(o)?o.enable:!1}function v(e){let{threadPool:o}=e,t=H.cpus().length;return C(o)?t:f(o)&&o.enable?o.size>t||!o.size?t:o.size:t}function T(e,o){let t=[];return Object.entries(o).forEach(([s,n])=>{"code"in n&&n.code&&!M(s,e.excludes)&&t.push([s,n])}),t}function w(e,o,t){let s=new d(e.log);s.info(`obfuscating ${o}...`);let n=$.obfuscate(t.code,e.options).getObfuscatedCode();return s.info(`obfuscation complete for ${o}.`),n}function A(e,o){return new Promise((t,s)=>{let n=new W(V.join(__dirname,"./worker/index.js"));n.postMessage({config:e,chunk:o}),n.on("message",r=>{o.forEach(([i,a])=>{let u=r.find(l=>l.fileName===i);u&&u.obfuscatedCode&&(a.code=u.obfuscatedCode)}),t(r),n.unref()}),n.on("error",r=>{s(r),n.unref()})})}var P={excludes:[],enable:!0,log:!0,apply:"build",autoExcludeNodeModules:!1,threadPool:!1,options:{compact:!0,controlFlowFlattening:!0,controlFlowFlatteningThreshold:1,deadCodeInjection:!1,debugProtection:!1,debugProtectionInterval:0,disableConsoleOutput:!1,identifierNamesGenerator:"hexadecimal",log:!1,numbersToExpressions:!1,renameGlobals:!1,selfDefending:!0,simplify:!0,splitStrings:!1,stringArray:!1,stringArrayCallsTransform:!1,stringArrayCallsTransformThreshold:.5,stringArrayEncoding:[],stringArrayIndexShift:!0,stringArrayRotate:!0,stringArrayShuffle:!0,stringArrayWrappersCount:1,stringArrayWrappersChainedCalls:!0,stringArrayWrappersParametersMaxCount:2,stringArrayWrappersType:"variable",stringArrayThreshold:.75,unicodeEscapeSequence:!1}},g="vendor-modules",h=Object.freeze({info:"\x1B[36m",warn:"\x1B[33m"});function D(){return m!=null&&m.version?Number(m.version.split(".")[0]):2}function I(e){let o=x(x({},P),e),t=new d(o.log),s=r=>{if(!o.enable||!o.autoExcludeNodeModules)return;r.build=r.build||{},r.build.rollupOptions=r.build.rollupOptions||{};let{output:i}=r.build.rollupOptions,a=u=>{if(o.excludes.push(g),u.includes("node_modules"))return g};if(!i){r.build.rollupOptions.output={manualChunks:a};return}if(k(i)){t.forceLog(h.warn,"rollupOptions.output is an array, ignoring autoExcludeNodeModules configuration.");return}if(f(i)){if(!i.manualChunks)i.manualChunks=a;else if(f(i.manualChunks))t.forceLog(h.warn,"rollupOptions.output.manualChunks is an object, ignoring autoExcludeNodeModules configuration.");else if(E(i.manualChunks)){let u=i.manualChunks;o.excludes.push(g),i.manualChunks=(l,c)=>l.includes("node_modules")?g:u(l,c)}}},n=async(r,{bundle:i})=>{if(!o.enable||!i)return r;t.forceLog("starting obfuscation process...");let a=performance.now(),u=T(o,i);if(S(o)){let c=Math.min(v(o),u.length),p=Math.ceil(u.length/c),y=[];for(let b=0;b<c;b++){let R=u.slice(b*p,(b+1)*p);y.push(A(o,R))}await Promise.all(y)}else u.forEach(([c,p])=>{p.code=w(o,c,p)});let l=L(performance.now()-a);return t.forceLog(h.info+"%s\x1B[0m %s","\u2713",`obfuscation process completed in ${l}.`),r};return{name:"vite-plugin-bundle-obfuscator",apply:o.apply,config:s,transformIndexHtml:D()>=5?{order:"post",handler:n}:{enforce:"post",transform:n}}}export{I as default};
